/// <reference path="../typings/d3/d3.d.ts" />
/// <reference path="../typings/es6-promise/es6-promise.d.ts"/>
/// <reference path="../typings/requirejs/require.d.ts"/>
/// <reference path="../Shared/InMemoryBrowserUsers.ts"/>
/// <reference path="../Shared/UserConstructor.ts"/>
requirejs.config({
    baseUrl: '/'
});
var users;
require(['Shared/InMemoryBrowserUsers', 'Shared/UserConstructor'], function (u, c) {
    users = new u.InMemoryBrowserUsers(window);
    var UIEntry = (function () {
        function UIEntry() {
            document.getElementById('new').addEventListener("mousedown", function () {
                UI.ClearUsers();
            });
            document.getElementById('user').addEventListener("keyup", function (e) {
                var code = e.keyCode;
                if (code === 13) {
                    AddUser();
                }
            });
            document.getElementById('add').addEventListener("mousedown", function () {
                AddUser();
            });
        }
        UIEntry.prototype.AddUser = function (username) {
            var _this = this;
            var textNode = document.createElement("span");
            textNode.setAttribute("class", "user");
            textNode.textContent = username;
            var deleteButton = document.createElement("a");
            deleteButton.setAttribute("href", "void(0);");
            deleteButton.textContent = "X";
            deleteButton.addEventListener("mousedown", function (e) {
                var el = e.target.parentNode;
                _this.ClearUser(el.textContent);
                var usernames = UI.GetUsers();
                saveUsers(usernames);
            });
            var newNode = document.createElement("li");
            newNode.appendChild(textNode);
            newNode.appendChild(deleteButton);
            document.getElementById('users').appendChild(newNode);
        };
        UIEntry.prototype.ClearUser = function (username) {
            var parent = document.getElementById('users');
            var nodeList = parent.childNodes;
            for (var i = nodeList.length; i--; i > 0) {
                if (username === nodeList[i].textContent) {
                    document.getElementById('users').removeChild(nodeList[i]);
                }
            }
        };
        UIEntry.prototype.ClearUsers = function () {
            var parent = document.getElementById('users');
            var nodeList = parent.childNodes;
            for (var i = nodeList.length; i--; i > 0) {
                document.getElementById('users').removeChild(nodeList[i]);
            }
        };
        UIEntry.prototype.GetUsername = function () {
            return document.getElementById('user').value;
        };
        UIEntry.prototype.ShowError = function (error) {
            alert(error);
        };
        UIEntry.prototype.ClearUsername = function () {
            document.getElementById('user').value = "";
        };
        UIEntry.prototype.FocusUsername = function () {
            document.getElementById('user').focus();
        };
        UIEntry.prototype.GetUsers = function () {
            var entry = document.getElementById('users').getElementsByClassName('user');
            var usernames = new Array();
            for (var i = 0; i < entry.length; i++) {
                usernames.push(entry.item(i).textContent);
            }
            return usernames;
        };
        ;
        return UIEntry;
    }());
    var UI = new UIEntry();
    var saveUsers = function (usernames) {
        var newusers = c.UserConstructor.createUsersByNames(usernames);
        users.setUsers(newusers).then(function (result) {
            console.log("Set users", result);
        });
    };
    var AddUser = function () {
        var username = UI.GetUsername();
        if (username) {
            var usernames = UI.GetUsers();
            var isUnique = !(usernames.filter(function (value) {
                return value === username;
            }).length);
            if (isUnique) {
                UI.AddUser(username);
                usernames = UI.GetUsers();
                saveUsers(usernames);
                UI.ClearUsername();
                setTimeout(function () { UI.FocusUsername(); }, 10);
            }
            else {
                UI.ShowError("already entered user" + username);
            }
        }
    };
    users.getUsers().then(function (data) {
        UI.ClearUsers();
        UI.FocusUsername();
        if (data && data.length) {
            var strings = data.map(function (user) {
                return user.name;
            });
            for (var i = 0; i < strings.length; i++) {
                UI.AddUser(strings[i]);
            }
        }
    });
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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b3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9kMy9kMy5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL2VzNi1wcm9taXNlL2VzNi1wcm9taXNlLmQudHNcIi8+XG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy9yZXF1aXJlanMvcmVxdWlyZS5kLnRzXCIvPlxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL1NoYXJlZC9Jbk1lbW9yeUJyb3dzZXJVc2Vycy50c1wiLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9TaGFyZWQvVXNlckNvbnN0cnVjdG9yLnRzXCIvPlxucmVxdWlyZWpzLmNvbmZpZygge1xuICAgIGJhc2VVcmwgOiAnLydcbn0pO1xuXG52YXIgdXNlcnM7XG5cbnJlcXVpcmUoWydTaGFyZWQvSW5NZW1vcnlCcm93c2VyVXNlcnMnLCAnU2hhcmVkL1VzZXJDb25zdHJ1Y3RvciddLCBmdW5jdGlvbih1LCBjKSB7XG4gICAgdXNlcnMgPSBuZXcgdS5Jbk1lbW9yeUJyb3dzZXJVc2Vycyh3aW5kb3cpO1xuICAgIFxuICAgIGNsYXNzIFVJRW50cnkge1xuICAgICAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXcnKS5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vkb3duXCIsICgpID0+IHtcbiAgICAgICAgICAgICAgICBVSS5DbGVhclVzZXJzKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyJykuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsIChlOktleWJvYXJkRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgY29kZSA9IGUua2V5Q29kZTtcbiAgICAgICAgICAgICAgICBpZihjb2RlID09PSAxMykge1xuICAgICAgICAgICAgICAgICAgICBBZGRVc2VyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWRkJykuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlZG93blwiLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgQWRkVXNlcigpO1xuICAgICAgICAgICAgfSk7ICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIEFkZFVzZXIodXNlcm5hbWUpIHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIHRleHROb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG4gICAgICAgICAgICB0ZXh0Tm9kZS5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBcInVzZXJcIik7XG4gICAgICAgICAgICB0ZXh0Tm9kZS50ZXh0Q29udGVudCA9IHVzZXJuYW1lO1xuXG4gICAgICAgICAgICB2YXIgZGVsZXRlQnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XG4gICAgICAgICAgICBkZWxldGVCdXR0b24uc2V0QXR0cmlidXRlKFwiaHJlZlwiLCBcInZvaWQoMCk7XCIpO1xuICAgICAgICAgICAgZGVsZXRlQnV0dG9uLnRleHRDb250ZW50ID0gXCJYXCI7XG4gICAgICAgICAgICBkZWxldGVCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlZG93blwiLCAoZTpNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIGVsID0gKDxFbGVtZW50PmUudGFyZ2V0KS5wYXJlbnROb2RlO1xuICAgICAgICAgICAgICAgIHRoaXMuQ2xlYXJVc2VyKGVsLnRleHRDb250ZW50KTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgdXNlcm5hbWVzID0gVUkuR2V0VXNlcnMoKTtcbiAgICAgICAgICAgICAgICBzYXZlVXNlcnModXNlcm5hbWVzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHZhciBuZXdOb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImxpXCIpO1xuICAgICAgICAgICAgbmV3Tm9kZS5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7XG4gICAgICAgICAgICBuZXdOb2RlLmFwcGVuZENoaWxkKGRlbGV0ZUJ1dHRvbik7XG5cbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VycycpLmFwcGVuZENoaWxkKG5ld05vZGUpO1xuICAgICAgICB9XG4gICAgICAgIENsZWFyVXNlciAodXNlcm5hbWUpIHtcbiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXNlcnMnKTtcbiAgICAgICAgICAgIHZhciBub2RlTGlzdCA9IHBhcmVudC5jaGlsZE5vZGVzO1xuICAgICAgICAgICAgZm9yICh2YXIgaT1ub2RlTGlzdC5sZW5ndGg7aS0tO2k+MCkge1xuICAgICAgICAgICAgICAgIGlmKHVzZXJuYW1lID09PSBub2RlTGlzdFtpXS50ZXh0Q29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXNlcnMnKS5yZW1vdmVDaGlsZChub2RlTGlzdFtpXSk7XG4gICAgICAgICAgICAgICAgfSAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgQ2xlYXJVc2VycyAoKSB7XG4gICAgICAgICAgICB2YXIgcGFyZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXJzJyk7XG4gICAgICAgICAgICB2YXIgbm9kZUxpc3QgPSBwYXJlbnQuY2hpbGROb2RlcztcbiAgICAgICAgICAgIGZvciAodmFyIGk9bm9kZUxpc3QubGVuZ3RoO2ktLTtpPjApe1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VycycpLnJlbW92ZUNoaWxkKG5vZGVMaXN0W2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBHZXRVc2VybmFtZSAoKSA6IHN0cmluZyB7XG4gICAgICAgICAgICByZXR1cm4gKDxIVE1MSW5wdXRFbGVtZW50PmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyJykpLnZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIFNob3dFcnJvciAoZXJyb3IpIHtcbiAgICAgICAgICAgIGFsZXJ0KGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgICBDbGVhclVzZXJuYW1lICgpIHtcbiAgICAgICAgICAgICg8SFRNTElucHV0RWxlbWVudD5kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXNlcicpKS52YWx1ZSA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgRm9jdXNVc2VybmFtZSAoKSB7XG4gICAgICAgICAgICAoPEhUTUxJbnB1dEVsZW1lbnQ+ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXInKSkuZm9jdXMoKTtcbiAgICAgICAgfVxuICAgICAgICBHZXRVc2VycyAoKSA6IEFycmF5PHN0cmluZz4ge1xuICAgICAgICAgICAgdmFyIGVudHJ5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXJzJykuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgndXNlcicpO1xuICAgICAgICAgICAgdmFyIHVzZXJuYW1lcyA9IG5ldyBBcnJheTxzdHJpbmc+KCk7XG4gICAgICAgICAgICBmb3IgKHZhciBpPTA7aTxlbnRyeS5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgICAgICAgdXNlcm5hbWVzLnB1c2goZW50cnkuaXRlbShpKS50ZXh0Q29udGVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdXNlcm5hbWVzOyAgICAgICAgICAgIFxuICAgICAgICB9O1xuXG4gICAgfVxuICAgIHZhciBVSSA9IG5ldyBVSUVudHJ5KCk7XG4gICAgXG4gICAgdmFyIHNhdmVVc2VycyA9ICh1c2VybmFtZXMpID0+IHtcbiAgICAgICAgdmFyIG5ld3VzZXJzID0gYy5Vc2VyQ29uc3RydWN0b3IuY3JlYXRlVXNlcnNCeU5hbWVzKHVzZXJuYW1lcyk7XG4gICAgICAgIHVzZXJzLnNldFVzZXJzKG5ld3VzZXJzKS50aGVuKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU2V0IHVzZXJzXCIsIHJlc3VsdCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHZhciBBZGRVc2VyID0gKCkgPT4ge1xuICAgICAgICB2YXIgdXNlcm5hbWUgPSBVSS5HZXRVc2VybmFtZSgpO1xuICAgICAgICBpZiAodXNlcm5hbWUpIHtcbiAgICAgICAgICAgIHZhciB1c2VybmFtZXMgPSBVSS5HZXRVc2VycygpO1xuICAgICAgICAgICAgdmFyIGlzVW5pcXVlID0gISh1c2VybmFtZXMuZmlsdGVyKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdXNlcm5hbWU7XG4gICAgICAgICAgICB9KS5sZW5ndGgpO1xuICAgICAgICAgICAgaWYoaXNVbmlxdWUpIHtcbiAgICAgICAgICAgICAgICBVSS5BZGRVc2VyKHVzZXJuYW1lKTtcbiAgICAgICAgICAgICAgICB1c2VybmFtZXMgPSBVSS5HZXRVc2VycygpO1xuICAgICAgICAgICAgICAgIHNhdmVVc2Vycyh1c2VybmFtZXMpO1xuICAgICAgICAgICAgICAgIFVJLkNsZWFyVXNlcm5hbWUoKTtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgVUkuRm9jdXNVc2VybmFtZSgpfSwxMCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIFVJLlNob3dFcnJvcihcImFscmVhZHkgZW50ZXJlZCB1c2VyXCIgKyB1c2VybmFtZSk7XG4gICAgICAgICAgICB9ICAgXG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgdXNlcnMuZ2V0VXNlcnMoKS50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgIFVJLkNsZWFyVXNlcnMoKTtcbiAgICAgICAgVUkuRm9jdXNVc2VybmFtZSgpO1xuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCkge1xuICAgICAgICAgICAgY29uc3Qgc3RyaW5nczpzdHJpbmdbXSA9IGRhdGEubWFwKCh1c2VyKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVzZXIubmFtZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wO2k8c3RyaW5ncy5sZW5ndGg7aSsrKSB7XG4gICAgICAgICAgICAgICAgVUkuQWRkVXNlcihzdHJpbmdzW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIFxufSk7XG5cbiJdfQ==
